'use strict';require('graceful-fs').gracefulify(require('fs')),require('react-native/local-cli/server/checkNodeVersion')(),require('react-native/setupBabel')();var e=require('commander'),r=require('path'),i=require("fs"),n=require("./config/common"),o=n.project_dir,t=n.API_LEVEL,a=n.PRELUDE,s=n.PRELUDEID,u=n.STEP,l=n.MOD,c=n.MOD_PLUG,d=n.makeDirs,f=n.exec,v=s;e.version("api_level:"+t).usage("[options] <packageName>").option("-a, --android","android\u7248\u672c").option("-i, --ios","ios\u7248\u672c").description("\u751f\u6210Bundle").parse(process.argv),(function(){if((e.args||[]).length<1)e.outputHelp();else{var n=e.args[0],t=r.join(o,n);if(!/^\S+(\.\S+)+$/.test(n)||!i.existsSync(t)||!i.statSync(t).isDirectory())return console.log("invalid package name: "+n),void e.outputHelp();if(!!e.ios==!!e.android){var s=r.relative(o,__filename);f("node",[s,"--android",n],function(){console.log("\n=====================================\n"),f("node",[s,"--ios",n])})}else{var p=e.android?"android":"ios";console.log('[MIOT]start to make '+p+' bundle for '+n);var g=r.join(t,"build",p);d(g);var m=r.join(g,"plug.bundle");i.existsSync(m)&&i.unlinkSync(m);var S=setTimeout(L,1e6);i.watchFile(m,{interval:50},function(e){e.size>10&&(clearTimeout(S),setTimeout(L,50))});var E=require('metro/src/Config'),y=require('metro/src/Server');E.DEFAULT.postProcessModules=function(e){return e.filter(function(e){return l(e.id)==c})};var D=new Map,_=1,q=i.readFileSync(r.join(o,"bin","config","modules"));if(q)(JSON.parse(q.toString()||"{}").modules||[]).forEach(function(e){D.set(e[1],e[0])}),q=null;y.DEFAULT_BUNDLE_OPTIONS.isolateModuleIDs=!0,y.DEFAULT_BUNDLE_OPTIONS.createModuleIdFactory=function(){return function(e){if(e==a)return v;var i=r.relative(o,e),n=D.get(i);return n||(n=v+_,_+=u),D.set(i,n),n}},process.argv=["","","bundle","--entry-file",r.join(n,"index.js"),"--bundle-output",r.join(g,"plug.bundle"),"--assets-dest",g,"--platform",p,"--dev","false","--minify","true","--verbose"],require('react-native/local-cli/cliEntry').run()}}function L(){i.unwatchFile(m);var e=i.readFileSync(m);i.writeFileSync(m,e.slice(e.indexOf("\n__d(function(")))}})();